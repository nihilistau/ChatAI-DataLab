name: Stability Gate

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 2 * * 0"

jobs:
  backend-tests:
    name: Backend pytest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python -m pip install --upgrade pip
      - run: python -m pip install -r playground/backend/requirements.txt
      - name: Run backend tests
        working-directory: playground/backend
        run: python -m pytest -q

  kitchen-tests:
    name: Kitchen + notebooks
    runs-on: ubuntu-latest
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python -m pip install --upgrade pip
      - run: python -m pip install -r kitchen/requirements.txt
      - name: Kitchen unit tests
        run: python -m pytest kitchen/tests -q
      - name: Notebook regression tests
        run: python -m pytest tests/test_notebooks.py -q
      - name: Upload executed notebooks
        uses: actions/upload-artifact@v4
        with:
          name: papermill-notebooks
          path: kitchen/notebooks/_papermill/*.ipynb
          if-no-files-found: ignore

  frontend-qa:
    name: Frontend lint + tests + build
    runs-on: ubuntu-latest
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: playground/frontend/package-lock.json
      - name: Install dependencies
        working-directory: playground/frontend
        run: npm ci
      - name: Lint
        working-directory: playground/frontend
        run: npm run lint
      - name: Vitest suite
        working-directory: playground/frontend
        run: npm run test -- --runInBand
      - name: Playground tests
        working-directory: playground/frontend
        run: npm run test:playground
      - name: Production build
        working-directory: playground/frontend
        run: npm run build

  storybook-builds:
    name: Storybook artifacts
    runs-on: ubuntu-latest
    needs: frontend-qa
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        working-directory: playground/frontend
        run: npm ci
      - name: Storybook (app)
        working-directory: playground/frontend
        run: npm run storybook:build
      - name: Storybook (control center)
        working-directory: playground/frontend
        run: npm run storybook:playground

  integrity-scan:
    name: Integrity checkpoint status
    runs-on: ubuntu-latest
    needs: [backend-tests, kitchen-tests, frontend-qa]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python -m pip install --upgrade pip
      - name: Run integrity status
        run: python scripts/project_integrity.py status | tee integrity-status.json
      - uses: actions/upload-artifact@v4
        with:
          name: integrity-status
          path: integrity-status.json
